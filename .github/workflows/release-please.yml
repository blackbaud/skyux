name: Release Please
on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - '[0-9]+.x.x'
env:
  RELEASE_PR_PREFIX: 'chore: release'
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: '${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}'
      - uses: actions/setup-node@v5
        with:
          cache: 'npm'
          node-version-file: '.nvmrc'
      - name: npm install
        run: npm ci
      - name: Next release
        if: ${{ github.event_name != 'push' || ! startsWith(github.event.head_commit.message, env.RELEASE_PR_PREFIX) }}
        # Create or update a release branch and its pull request.
        run: npx skyux-dev release ${{ github.event_name == 'workflow_dispatch' && ! endsWith(github.event.ref, 'main') && ! endsWith(github.event.ref, '.x.x') && '--dry-run=true' || '' }}
        env:
          GH_TOKEN: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
      - uses: actions/github-script@v8
        name: Release
        if: ${{ github.event_name == 'push' && startsWith(github.event.head_commit.message, env.RELEASE_PR_PREFIX) }}
        id: release
        # Create a release based on the release pull request.
        with:
          github-token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          script: |
            const prevVersion = JSON.parse((await exec.getExecOutput('git', ['cat-file', '--textconv', `${context.payload.before}:package.json`])).stdout).version;
            const nextVersion = JSON.parse((await exec.getExecOutput('git', ['cat-file', '--textconv', `${context.payload.after}:package.json`])).stdout).version;
            if (!nextVersion || prevVersion === nextVersion) {
              console.log('No version change detected. Exiting.');
              process.exit(0);
            }
            core.setOutput('release_created', '1');
            core.setOutput('tag_name', nextVersion);

            const releaseExists = await github.rest.repos.getReleaseByTag({ ...context.repo, tag: nextVersion }).then(() => true).catch(() => false);
            if (!releaseExists) {
              const releaseNotes = (await exec.getExecOutput('npx', ['skyux-dev', 'release-notes', `--releaseName=${nextVersion}`])).stdout;
              await github.rest.repos.createRelease({ ...context.repo, tag_name: nextVersion, body: releaseNotes, prerelease: nextVersion.includes('-') });
            }
      - name: Build
        if: ${{ steps.release.outputs.release_created }}
        run: npx skyux-dev create-packages-dist --skipNxCache
      - name: Publish
        if: ${{ steps.release.outputs.release_created }}
        run: npx skyux-dev publish-packages-dist
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Capture logs
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: npm-logs
          path: /home/runner/.npm/_logs
          retention-days: 3
      - name: Notify Slack (success)
        if: ${{ steps.release.outputs.release_created }}
        uses: rtCamp/action-slack-notify@07cbdbfd6c6190970778d8f98f11d073b2932aae # v2.3.3
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: Successfully published SKY UX ${{ steps.release.outputs.tag_name }} to NPM. http://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md
          SLACK_ICON: https://github.com/blackbaud.png?size=48
          SLACK_USERNAME: SKY UX
      - name: Notify Slack (failure)
        if: ${{ failure() && steps.release.outputs.release_created }}
        uses: rtCamp/action-slack-notify@07cbdbfd6c6190970778d8f98f11d073b2932aae # v2.3.3
        env:
          SLACK_COLOR: ${{ job.status }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: Failed to publish SKY UX ${{ steps.release.outputs.tag_name }} to NPM!
          SLACK_ICON: https://github.com/blackbaud.png?size=48
          SLACK_USERNAME: SKY UX
      - name: Notify Slack (failure, non-release)
        if: ${{ failure() && !steps.release.outputs.release_created }}
        uses: rtCamp/action-slack-notify@07cbdbfd6c6190970778d8f98f11d073b2932aae # v2.3.3
        env:
          SLACK_COLOR: ${{ job.status }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: Failed when preparing SKY UX release!
          SLACK_ICON: https://github.com/blackbaud.png?size=48
          SLACK_USERNAME: SKY UX
          #cor-skyux-notifications
          SLACK_CHANNEL: C01GY7ZP4HM
